{% extends "base.html" %}

{% block title %}Enhanced Librarian Dashboard - Lancaster University Library{% endblock %}

{% block content %}
<style>
/* Modern Dashboard Styling */
.dashboard-card {
    transition: all 0.3s ease;
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.btn-white {
    background-color: white;
    color: #333;
    border: 1px solid rgba(255, 255, 255, 0.8);
    transition: all 0.3s ease;
}

.btn-white:hover {
    background-color: #f8f9fa;
    color: #333;
    border-color: #dee2e6;
    transform: translateY(-2px);
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(139, 0, 0, 0.15);
}

.stat-card {
    background: linear-gradient(135deg, #B22222 0%, #8B0000 100%);
    color: white;
    border-radius: 15px;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transform: translate(30px, -30px);
}

.stat-card.warning {
    background: linear-gradient(135deg, #DC143C 0%, #A0522D 100%);
}

.stat-card.success {
    background: linear-gradient(135deg, #CD5C5C 0%, #800000 100%);
}

.stat-card.info {
    background: linear-gradient(135deg, #B22222 0%, #8B0000 100%);
}

.stat-card.danger {
    background: linear-gradient(135deg, #CC0000 0%, #8B0000 100%);
}

.hero-section {
    background: linear-gradient(135deg, #f6f6f6 0%, #d32121 100%);
    border-radius: 20px;
    position: relative;
    overflow: hidden;
}

.hero-section::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 300px;
    height: 300px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    z-index: 1;
}

.hero-content {
    position: relative;
    z-index: 2;
}

.action-card {
    border: none;
    border-radius: 15px;
    transition: all 0.3s ease;
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    box-shadow: 0 4px 15px rgba(139, 0, 0, 0.1);
}

.action-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 10px 30px rgba(139, 0, 0, 0.2);
}

.action-icon {
    width: 70px;
    height: 70px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 2rem;
    color: white;
    position: relative;
    overflow: hidden;
}

.action-icon.primary {
    background: linear-gradient(135deg, #B22222 0%, #8B0000 100%);
}

.action-icon.success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.action-icon.warning {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
}

.action-icon.info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
}

.metric-card {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    text-align: center;
    border: none;
    box-shadow: 0 8px 25px rgba(139, 0, 0, 0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #B22222 0%, #DC143C 100%);
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 35px rgba(139, 0, 0, 0.15);
}

.metric-number {
    font-size: 3rem;
    font-weight: 700;
    background: linear-gradient(135deg, #B22222 0%, #DC143C 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
}

.sidebar-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(139, 0, 0, 0.08);
    border: none;
    transition: all 0.3s ease;
}

.sidebar-card:hover {
    box-shadow: 0 6px 25px rgba(139, 0, 0, 0.12);
}

.alert-custom {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid;
}

.activity-timeline {
    position: relative;
    padding-left: 2rem;
}

.activity-timeline::before {
    content: '';
    position: absolute;
    left: 12px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, #B22222, #DC143C);
}

.activity-item {
    position: relative;
    padding: 1rem 0;
    background: white;
    border-radius: 10px;
    margin-bottom: 1rem;
    padding-left: 1rem;
    box-shadow: 0 2px 10px rgba(139, 0, 0, 0.08);
}

.activity-item::before {
    content: '';
    position: absolute;
    left: -1.75rem;
    top: 1.5rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: linear-gradient(135deg, #B22222 0%, #DC143C 100%);
    border: 3px solid white;
    box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
}

.management-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
}

.pulse-animation {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(178, 34, 34, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(178, 34, 34, 0); }
    100% { box-shadow: 0 0 0 0 rgba(178, 34, 34, 0); }
}

.glass-effect {
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.2);
}
</style>

<!-- Hero Welcome Section -->
<div class="hero-section text-white p-5 mb-5">
    <div class="hero-content">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="mb-4">
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="fas fa-university me-3"></i>
                        Welcome back, {{ session.name }}!
                    </h1>
                    <p class="lead mb-2 opacity-90">Your comprehensive library management dashboard</p>
                    <small class="opacity-75 d-block">
                        <i class="fas fa-clock me-1"></i>
                        Last login: {{ last_login }}
                    </small>
                </div>
                
                <!-- Quick Action Buttons -->
                <div class="d-flex flex-wrap gap-3">
                    <a href="{{ url_for('add_book') }}" class="btn btn-light btn-sm px-4 shadow-sm">
                        <i class="fas fa-plus-circle me-2 text-primary"></i>
                        <span class="text-dark fw-semibold">Add Book</span>
                    </a>
                    <a href="{{ url_for('enhanced_add_member') }}" class="btn btn-light btn-sm px-4 shadow-sm">
                        <i class="fas fa-user-plus me-2 text-success"></i>
                        <span class="text-dark fw-semibold">Add Member</span>
                    </a>
                    <a href="{{ url_for('loan_book') }}" class="btn btn-light btn-sm px-4 shadow-sm">
                        <i class="fas fa-handshake me-2 text-warning"></i>
                        <span class="text-dark fw-semibold">Process Loan</span>
                    </a>
                    <a href="{{ url_for('advanced_search') }}" class="btn btn-white btn-sm px-4 border shadow-sm">
                        <i class="fas fa-search me-2 text-info"></i>
                        <span class="text-dark fw-semibold">Advanced Search</span>
                    </a>
                </div>
            </div>
            
            <div class="col-lg-4 text-end">
                <div class="d-flex flex-column gap-2">
                    <button class="btn btn-white btn-sm border shadow-sm" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-2 text-info"></i>
                        <span class="text-dark fw-semibold">Refresh Dashboard</span>
                    </button>
                    <a href="{{ url_for('logout') }}" class="btn btn-white btn-sm border shadow-sm">
                        <i class="fas fa-sign-out-alt me-2 text-danger"></i>
                        <span class="text-dark fw-semibold">Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Critical Alerts -->
{% if stats.overdue_loans > 0 or stats.unpaid_fines > 0 %}
<div class="row mb-4">
    <div class="col-12">
        {% if stats.overdue_loans > 0 %}
        <div class="alert alert-danger alert-custom d-flex align-items-center">
            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
            <div>
                <h5 class="alert-heading mb-1">Attention Required!</h5>
                <p class="mb-0">{{ stats.overdue_loans }} books are overdue. 
                <a href="{{ url_for('loans') }}" class="alert-link">View overdue loans</a></p>
            </div>
        </div>
        {% endif %}
        
        {% if stats.unpaid_fines > 0 %}
        <div class="alert alert-warning alert-custom d-flex align-items-center">
            <i class="fas fa-dollar-sign fa-2x me-3"></i>
            <div>
                <h5 class="alert-heading mb-1">Outstanding Fines</h5>
                <p class="mb-0">{{ stats.unpaid_fines }} unpaid fines need attention. 
                <a href="{{ url_for('fines') }}" class="alert-link">Manage fines</a></p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Enhanced Statistics Dashboard -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card text-center p-3">
            <i class="fas fa-book fa-3x mb-3 opacity-75"></i>
            <h3 class="mb-1">{{ stats.total_books }}</h3>
            <p class="mb-0">Total Books</p>
            <small class="opacity-75">{{ stats.available_books }} available</small>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card success text-center p-3">
            <i class="fas fa-users fa-3x mb-3 opacity-75"></i>
            <h3 class="mb-1">{{ stats.total_members }}</h3>
            <p class="mb-0">Active Members</p>
            <small class="opacity-75">{{ stats.new_members_month }} new this month</small>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card warning text-center p-3">
            <i class="fas fa-handshake fa-3x mb-3 opacity-75"></i>
            <h3 class="mb-1">{{ stats.active_loans }}</h3>
            <p class="mb-0">Active Loans</p>
            <small class="opacity-75">{{ stats.active_reservations }} reservations</small>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card {% if stats.overdue_loans > 0 %}danger{% else %}success{% endif %} text-center p-3">
            <i class="fas fa-exclamation-circle fa-3x mb-3 opacity-75"></i>
            <h3 class="mb-1">{{ stats.overdue_loans }}</h3>
            <p class="mb-0">Overdue Books</p>
            <small class="opacity-75">{{ stats.unread_messages }} unread messages</small>
        </div>
    </div>
</div>

<!-- Main Navigation Tabs -->
<ul class="nav nav-pills mb-4" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">
            <i class="fas fa-home me-2"></i>Overview
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="books-tab" data-bs-toggle="pill" data-bs-target="#books-panel" type="button" role="tab">
            <i class="fas fa-book me-2"></i>Books
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="members-tab" data-bs-toggle="pill" data-bs-target="#members-panel" type="button" role="tab">
            <i class="fas fa-users me-2"></i>Members
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="analytics-tab" data-bs-toggle="pill" data-bs-target="#analytics-panel" type="button" role="tab">
            <i class="fas fa-chart-bar me-2"></i>Analytics
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="system-tab" data-bs-toggle="pill" data-bs-target="#system-panel" type="button" role="tab">
            <i class="fas fa-cog me-2"></i>System
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="dashboardTabContent">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <!-- Key Metrics Summary -->
        <div class="row g-4 mb-5">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header bg-gradient text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Library Performance Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="action-icon primary mb-3">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <div class="metric-number">{{ stats.total_books }}</div>
                                    <h6 class="text-muted mb-1">Total Collection</h6>
                                    <small class="text-success">{{ stats.available_books }} available</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="action-icon success mb-3">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="metric-number">{{ stats.total_members }}</div>
                                    <h6 class="text-muted mb-1">Active Members</h6>
                                    <small class="text-info">{{ stats.new_members_month }} this month</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="action-icon warning mb-3">
                                        <i class="fas fa-handshake"></i>
                                    </div>
                                    <div class="metric-number">{{ stats.active_loans }}</div>
                                    <h6 class="text-muted mb-1">Current Loans</h6>
                                    <small class="text-primary">{{ stats.active_reservations }} reservations</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card {% if stats.overdue_loans > 0 %}pulse-animation{% endif %}">
                                    <div class="action-icon {% if stats.overdue_loans > 0 %}danger{% else %}success{% endif %} mb-3">
                                        <i class="fas fa-{% if stats.overdue_loans > 0 %}exclamation-triangle{% else %}check-circle{% endif %}"></i>
                                    </div>
                                    <div class="metric-number">{{ stats.overdue_loans }}</div>
                                    <h6 class="text-muted mb-1">Overdue Items</h6>
                                    <small class="{% if stats.overdue_loans > 0 %}text-danger{% else %}text-success{% endif %}">
                                        {% if stats.overdue_loans > 0 %}Requires attention{% else %}All good!{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row g-4">
            <!-- Featured Actions -->
            <div class="col-lg-6">
                <div class="card dashboard-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-rocket me-2"></i>Featured Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="action-card p-4 text-center">
                                    <div class="action-icon primary">
                                        <i class="fas fa-plus-circle"></i>
                                    </div>
                                    <h6 class="fw-bold mb-2">Add New Book</h6>
                                    <p class="text-muted small mb-3">Expand your collection with new titles</p>
                                    <a href="{{ url_for('add_book') }}" class="btn btn-primary btn-sm">
                                        Get Started
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="action-card p-4 text-center">
                                    <div class="action-icon success">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <h6 class="fw-bold mb-2">Register Member</h6>
                                    <p class="text-muted small mb-3">Welcome new library members</p>
                                    <a href="{{ url_for('enhanced_add_member') }}" class="btn btn-success btn-sm">
                                        Add Member
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="action-card p-4 text-center">
                                    <div class="action-icon warning">
                                        <i class="fas fa-handshake"></i>
                                    </div>
                                    <h6 class="fw-bold mb-2">Process Loan</h6>
                                    <p class="text-muted small mb-3">Quick book lending workflow</p>
                                    <a href="{{ url_for('loan_book') }}" class="btn btn-warning btn-sm">
                                        Start Process
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="action-card p-4 text-center">
                                    <div class="action-icon success">
                                        <i class="fas fa-undo"></i>
                                    </div>
                                    <h6 class="fw-bold mb-2">Return Book</h6>
                                    <p class="text-muted small mb-3">Process book returns efficiently</p>
                                    <a href="{{ url_for('loans') }}" class="btn btn-success btn-sm">
                                        Return Book
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="action-card p-4 text-center">
                                    <div class="action-icon info">
                                        <i class="fas fa-search-plus"></i>
                                    </div>
                                    <h6 class="fw-bold mb-2">Advanced Search</h6>
                                    <p class="text-muted small mb-3">Find books with detailed filters</p>
                                    <a href="{{ url_for('advanced_search') }}" class="btn btn-info btn-sm">
                                        Search Now
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity Timeline -->
            <div class="col-lg-6">
                <div class="card dashboard-card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Library Activity</h5>
                    </div>
                    <div class="card-body">
                        <div class="activity-timeline">
                            <!-- Sample activity items - in real app, this would be dynamic -->
                            <div class="activity-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong class="text-primary">New Book Added</strong>
                                        <p class="mb-0 small text-muted">"Advanced Python Programming" by John Smith</p>
                                    </div>
                                    <small class="text-muted">2 hours ago</small>
                                </div>
                            </div>
                            
                            <div class="activity-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong class="text-success">Member Registered</strong>
                                        <p class="mb-0 small text-muted">Sarah Johnson joined as Premium member</p>
                                    </div>
                                    <small class="text-muted">5 hours ago</small>
                                </div>
                            </div>
                            
                            <div class="activity-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong class="text-warning">Book Returned</strong>
                                        <p class="mb-0 small text-muted">"Data Structures" returned by Mike Davis</p>
                                    </div>
                                    <small class="text-muted">1 day ago</small>
                                </div>
                            </div>
                            
                            <div class="activity-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong class="text-info">System Update</strong>
                                        <p class="mb-0 small text-muted">Library management system updated to v2.1</p>
                                    </div>
                                    <small class="text-muted">2 days ago</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <a href="{{ url_for('audit_logs') }}" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-list me-2"></i>View Full Activity Log
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Popular Books & Notifications Row -->
        <div class="row g-4 mt-1">
            <!-- Popular Books -->
            <div class="col-lg-6">
                <div class="sidebar-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-star me-2"></i>Popular Books</h5>
                    </div>
                    <div class="card-body">
                        {% if popular_books %}
                            <!-- Show top 5 popular books in main view -->
                            <div id="popularBooksPreview">
                                {% for book in popular_books[:5] %}
                                <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                                    <h6 class="mb-1">{{ book[1] }}</h6>
                                    <small class="text-muted">by {{ book[2] }}</small>
                                    <div class="mt-1">
                                        <span class="badge bg-primary">{{ book[3] }} loans</span>
                                        {% if book[4] > 0 %}
                                        <span class="badge bg-warning">{{ "%.1f"|format(book[4]) }}★</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Collapsible section for remaining books -->
                            {% if popular_books|length > 5 %}
                            <div class="collapse" id="morePopularBooks">
                                <div class="border-top pt-3">
                                    {% for book in popular_books[5:] %}
                                    <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                                        <h6 class="mb-1">{{ book[1] }}</h6>
                                        <small class="text-muted">by {{ book[2] }}</small>
                                        <div class="mt-1">
                                            <span class="badge bg-primary">{{ book[3] }} loans</span>
                                            {% if book[4] > 0 %}
                                            <span class="badge bg-warning">{{ "%.1f"|format(book[4]) }}★</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#morePopularBooks" aria-expanded="false">
                                <span class="show-more-text"><i class="fas fa-chevron-down me-1"></i>Show {{ popular_books|length - 5 }} More Books</span>
                                <span class="show-less-text" style="display: none;"><i class="fas fa-chevron-up me-1"></i>Show Less</span>
                            </button>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No loan data available yet.</p>
                        {% endif %}
                        <div class="mt-3">
                            <small class="text-info">Displaying {{ popular_books|length if popular_books else 0 }} most popular books</small>
                        </div>
                        <a href="{{ url_for('analytics') }}" class="btn btn-sm btn-outline-info">View Full Analytics</a>
                    </div>
                </div>
            </div>
            
            <!-- Recent Messages & Announcements -->
            <div class="col-lg-6">
                <div class="sidebar-card">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Notifications</h5>
                    </div>
                    <div class="card-body">
                        <!-- Announcements -->
                        {% if announcements %}
                            <h6 class="text-muted mb-2">Recent Announcements</h6>
                            {% for announcement in announcements[:2] %}
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span class="badge bg-{{ 'danger' if announcement[6] == 'high' else ('warning' if announcement[6] == 'medium' else 'secondary') }}">
                                        {{ announcement[6].title() }}
                                    </span>
                                    <small class="text-muted">{{ announcement[4] }}</small>
                                </div>
                                <h6 class="mt-1 mb-1">{{ announcement[1] }}</h6>
                                <p class="small text-muted mb-0">{{ announcement[2][:80] }}...</p>
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Messages -->
                        {% if messages %}
                            <h6 class="text-muted mb-2 mt-3">Recent Messages</h6>
                            {% for message in messages[:2] %}
                            <div class="mb-2 message-item border rounded p-2 {{ 'bg-light' if not message[7] else '' }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <strong class="small">{{ message[9] or 'Unknown' }}</strong>
                                        <small class="text-muted ms-2">{{ message[6] }}</small>
                                        {% if not message[7] %}
                                        <span class="badge bg-success ms-2">New</span>
                                        {% endif %}
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="replyToMessage({{ message[0] }}, {{ message[1] }}, '{{ message[9] or 'Unknown' }}', '{{ message[4] }}', '{{ message[3] }}')"
                                            title="Reply">
                                        <i class="fas fa-reply"></i>
                                    </button>
                                </div>
                                <div class="mt-1">
                                    <small class="fw-bold">{{ message[3] }}</small>
                                </div>
                                <p class="small mb-0 mt-1">{{ message[4][:60] }}{% if message[4]|length > 60 %}...{% endif %}</p>
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        {% if not announcements and not messages %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No notifications at this time</p>
                        </div>
                        {% endif %}
                        
                        <div class="mt-3">
                            <a href="{{ url_for('messages') }}" class="btn btn-sm btn-outline-warning me-2">All Messages</a>
                            <a href="{{ url_for('announcements') }}" class="btn btn-sm btn-outline-secondary">Announcements</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Books Management Tab -->
    <div class="tab-pane fade" id="books-panel" role="tabpanel">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-book me-2"></i>Book Management</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('add_book') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Add New Book
                            </a>
                            <a href="{{ url_for('books') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-list me-2"></i>View All Books
                            </a>
                            <a href="{{ url_for('book_categories') }}" class="btn btn-outline-info">
                                <i class="fas fa-tags me-2"></i>Manage Categories
                            </a>
                            <a href="{{ url_for('bulk_import') }}" class="btn btn-outline-warning">
                                <i class="fas fa-upload me-2"></i>Bulk Import
                            </a>
                            <a href="{{ url_for('inventory_alerts') }}" class="btn btn-outline-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>Inventory Alerts
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Book Reservations</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 class="text-info">Active Reservations: {{ stats.active_reservations }}</h6>
                        </div>
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('reservations') }}" class="btn btn-outline-primary">
                                <i class="fas fa-calendar-check me-2"></i>Manage Reservations
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Members Management Tab -->
    <div class="tab-pane fade" id="members-panel" role="tabpanel">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Member Management</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('enhanced_add_member') }}" class="btn btn-success">
                                <i class="fas fa-user-plus me-2"></i>Add New Member
                            </a>
                            <a href="{{ url_for('members') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-users me-2"></i>View All Members
                            </a>
                            <a href="{{ url_for('member_tiers') }}" class="btn btn-outline-info">
                                <i class="fas fa-layer-group me-2"></i>Membership Tiers
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Financial Management</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 class="text-warning">Unpaid Fines: {{ stats.unpaid_fines }}</h6>
                        </div>
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('fines') }}" class="btn btn-outline-warning">
                                <i class="fas fa-money-bill-wave me-2"></i>Manage Fines
                            </a>
                           
                        
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analytics Tab -->
    <div class="tab-pane fade" id="analytics-panel" role="tabpanel">
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Analytics Dashboard</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <h3 class="text-primary">{{ stats.total_books }}</h3>
                                <p class="text-muted">Total Collection</p>
                            </div>
                            <div class="col-md-4">
                                <h3 class="text-success">{{ stats.active_loans }}</h3>
                                <p class="text-muted">Active Circulation</p>
                            </div>
                            <div class="col-md-4">
                                <h3 class="text-info">{{ stats.total_members }}</h3>
                                <p class="text-muted">Registered Users</p>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <a href="{{ url_for('analytics') }}" class="btn btn-primary">
                                <i class="fas fa-chart-line me-2"></i>Detailed Analytics
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Reports</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('reports') }}" class="btn btn-outline-primary">
                                <i class="fas fa-file-chart-line me-2"></i>All Reports
                            </a>
                            <a href="{{ url_for('analytics') }}" class="btn btn-outline-success">
                                <i class="fas fa-chart-bar me-2"></i>Library Analytics
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Management Tab -->
    <div class="tab-pane fade" id="system-panel" role="tabpanel">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cog me-2"></i>System Administration</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('system_settings') }}" class="btn btn-outline-primary">
                                <i class="fas fa-sliders-h me-2"></i>System Settings
                            </a>
                            <a href="{{ url_for('user_management') }}" class="btn btn-outline-success">
                                <i class="fas fa-user-cog me-2"></i>User Management
                            </a>
                            <a href="{{ url_for('audit_logs') }}" class="btn btn-outline-warning">
                                <i class="fas fa-history me-2"></i>Audit Logs
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Communication</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('create_announcement') }}" class="btn btn-outline-info">
                                <i class="fas fa-plus-circle me-2"></i>Create Announcement
                            </a>
                            <a href="{{ url_for('messages') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-envelope me-2"></i>Messages ({{ stats.unread_messages }})</a>
                            <a href="{{ url_for('send_message') }}" class="btn btn-outline-primary">
                                <i class="fas fa-paper-plane me-2"></i>Send Message
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reply to Message Modal -->
<div class="modal fade" id="replyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-reply me-2"></i>Reply to Message
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label"><strong>Replying to:</strong></label>
                    <div id="originalSender" class="text-muted"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Original Message:</strong></label>
                    <div id="originalMessage" class="border rounded p-3 bg-light"></div>
                </div>
                <div class="mb-3">
                    <label for="replySubject" class="form-label">Subject</label>
                    <input type="text" class="form-control" id="replySubject" readonly>
                </div>
                <div class="mb-3">
                    <label for="replyMessage" class="form-label">Your Reply</label>
                    <textarea class="form-control" id="replyMessage" rows="5" 
                              placeholder="Type your reply here..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendReply()">
                    <i class="fas fa-paper-plane me-2"></i>Send Reply
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function refreshDashboard() {
    // Add loading indicator
    const refreshBtn = document.querySelector('[onclick="refreshDashboard()"]');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    // Simulate refresh (in real app, this would fetch new data)
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Auto-refresh every 5 minutes
setInterval(() => {
    fetch('/api/dashboard_stats')
        .then(response => response.json())
        .then(data => {
            // Update stats without full page reload
            console.log('Dashboard stats updated:', data);
        })
        .catch(error => console.log('Auto-refresh failed:', error));
}, 300000);

// Handle popular books collapse toggle
document.addEventListener('DOMContentLoaded', function () {
    const morePopularBooks = document.getElementById('morePopularBooks');
    if (morePopularBooks) {
        morePopularBooks.addEventListener('show.bs.collapse', function () {
            const button = document.querySelector('[data-bs-target="#morePopularBooks"]');
            button.querySelector('.show-more-text').style.display = 'none';
            button.querySelector('.show-less-text').style.display = 'inline';
        });
        
        morePopularBooks.addEventListener('hide.bs.collapse', function () {
            const button = document.querySelector('[data-bs-target="#morePopularBooks"]');
            button.querySelector('.show-more-text').style.display = 'inline';
            button.querySelector('.show-less-text').style.display = 'none';
        });
    }
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Reply functionality
let currentReplyData = {};

function replyToMessage(messageId, fromUserId, senderName, message, subject) {
    // Store reply data
    currentReplyData = {
        messageId: messageId,
        studentUserId: fromUserId
    };
    
    // Populate modal fields
    document.getElementById('originalSender').textContent = senderName;
    document.getElementById('originalMessage').textContent = message;
    document.getElementById('replySubject').value = 'Re: ' + subject;
    document.getElementById('replyMessage').value = '';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('replyModal'));
    modal.show();
}

function sendReply() {
    const replyMessage = document.getElementById('replyMessage').value.trim();
    const subject = document.getElementById('replySubject').value;
    
    if (!replyMessage) {
        alert('Please enter a reply message.');
        return;
    }
    
    // Send reply to server
    fetch('/librarian/reply_message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            original_message_id: currentReplyData.messageId,
            student_user_id: currentReplyData.studentUserId,
            message: replyMessage,
            subject: subject
        })
    })
    .then(response => response.json())
    .then(data => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('replyModal'));
        modal.hide();
        
        if (data.success) {
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong>Success!</strong> ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
            
            // Refresh the page to show updated message status
            setTimeout(() => location.reload(), 1500);
        } else {
            alert('Failed to send reply: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const modal = bootstrap.Modal.getInstance(document.getElementById('replyModal'));
        modal.hide();
        alert('Failed to send reply. Please try again.');
    });
}
</script>
{% endblock %}
