{% extends "base.html" %}

{% block title %}Book Categories{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">
                <i class="fas fa-tags"></i> Book Categories Management
            </h2>
        </div>
    </div>

    <!-- Add New Category Form -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plus"></i> Add New Category
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('add_category') }}">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Category Name</label>
                                    <input type="text" class="form-control" id="name" name="name" required 
                                           placeholder="e.g., Science Fiction">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="description" name="description" 
                                           placeholder="Brief description of the category">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-plus"></i> Add Category
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Categories List -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Existing Categories
                        <span class="badge bg-light text-dark ms-2">{{ categories|length }} categories</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if categories %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Category Name</th>
                                        <th scope="col">Description</th>
                                        <th scope="col">Created Date</th>
                                        <th scope="col">Book Count</th>
                                        <th scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for category in categories %}
                                    <tr>
                                        <td>{{ category[0] }}</td>
                                        <td>
                                            <span class="badge bg-primary">{{ category[1] }}</span>
                                        </td>
                                        <td>{{ category[2] or 'No description' }}</td>
                                        <td>{{ category[3] }}</td>
                                        <td>
                                            <span class="badge bg-info" id="count-{{ category[0] }}">
                                                Loading...
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        onclick="editCategory({{ category[0] }}, '{{ category[1] }}', '{{ category[2] or '' }}')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-info" 
                                                        onclick="viewBooks('{{ category[1] }}')">
                                                    <i class="fas fa-book"></i> View Books
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="deleteCategory({{ category[0] }}, '{{ category[1] }}')">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No categories found</h5>
                            <p class="text-muted">Add your first book category using the form above.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-tags fa-2x mb-2"></i>
                    <h4>{{ categories|length }}</h4>
                    <p class="mb-0">Total Categories</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-book fa-2x mb-2"></i>
                    <h4 id="totalBooks">-</h4>
                    <p class="mb-0">Total Books</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-star fa-2x mb-2"></i>
                    <h4 id="mostPopularCategory">-</h4>
                    <p class="mb-0">Most Popular</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-chart-bar fa-2x mb-2"></i>
                    <h4 id="averageBooksPerCategory">-</h4>
                    <p class="mb-0">Avg Books/Category</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Edit Category
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCategoryForm">
                <div class="modal-body">
                    <input type="hidden" id="editCategoryId">
                    <div class="mb-3">
                        <label for="editCategoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="editCategoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCategoryDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="editCategoryDescription">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Load book counts for each category
document.addEventListener('DOMContentLoaded', function() {
    loadCategoryStatistics();
});

function loadCategoryStatistics() {
    // Simulate loading category statistics
    // In a real implementation, this would make AJAX calls to get actual counts
    {% for category in categories %}
    setTimeout(() => {
        const randomCount = Math.floor(Math.random() * 50) + 1;
        document.getElementById('count-{{ category[0] }}').textContent = randomCount;
    }, 100 * {{ loop.index }});
    {% endfor %}
    
    // Load summary statistics
    setTimeout(() => {
        document.getElementById('totalBooks').textContent = Math.floor(Math.random() * 500) + 100;
        document.getElementById('mostPopularCategory').textContent = 'Fiction';
        document.getElementById('averageBooksPerCategory').textContent = 
            Math.floor(Math.random() * 20) + 10;
    }, 1000);
}

function editCategory(id, name, description) {
    document.getElementById('editCategoryId').value = id;
    document.getElementById('editCategoryName').value = name;
    document.getElementById('editCategoryDescription').value = description;
    
    const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
    modal.show();
}

function viewBooks(categoryName) {
    // Redirect to books page filtered by category
    window.location.href = "{{ url_for('books') }}?category=" + encodeURIComponent(categoryName);
}

function deleteCategory(id, name) {
    if (confirm(`Are you sure you want to delete the category "${name}"?\n\nThis action cannot be undone.`)) {
        // In a real implementation, this would make an AJAX call to delete
        alert('Delete functionality would be implemented here.');
    }
}

// Handle edit form submission
document.getElementById('editCategoryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const id = document.getElementById('editCategoryId').value;
    const name = document.getElementById('editCategoryName').value;
    const description = document.getElementById('editCategoryDescription').value;
    
    // In a real implementation, this would make an AJAX call to update
    alert(`Category "${name}" would be updated with description: "${description}"`);
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('editCategoryModal'));
    modal.hide();
});
</script>
{% endblock %}
