{% extends "base.html" %}

{% block title %}Advanced Search{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">
                <i class="fas fa-search"></i> Advanced Book Search
            </h2>
        </div>
    </div>

    <!-- Search Form -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-filter"></i> Search Filters
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('advanced_search') }}">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="title" class="form-label">
                                        <i class="fas fa-book"></i> Title
                                    </label>
                                    <input type="text" class="form-control" id="title" name="title" 
                                           value="{{ request.args.get('title', '') }}" 
                                           placeholder="Enter book title...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="author" class="form-label">
                                        <i class="fas fa-user"></i> Author
                                    </label>
                                    <input type="text" class="form-control" id="author" name="author" 
                                           value="{{ request.args.get('author', '') }}" 
                                           placeholder="Enter author name...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="genre" class="form-label">
                                        <i class="fas fa-tags"></i> Genre/Category
                                    </label>
                                    <select class="form-select" id="genre" name="genre">
                                        <option value="">All Genres</option>
                                        {% if categories %}
                                            {% for category in categories %}
                                            <option value="{{ category[1] }}" 
                                                    {% if request.args.get('genre') == category[1] %}selected{% endif %}>
                                                {{ category[1] }}
                                            </option>
                                            {% endfor %}
                                        {% else %}
                                            <option value="Fiction">Fiction</option>
                                            <option value="Non-Fiction">Non-Fiction</option>
                                            <option value="Science">Science</option>
                                            <option value="Technology">Technology</option>
                                            <option value="History">History</option>
                                            <option value="Biography">Biography</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="year_from" class="form-label">
                                        <i class="fas fa-calendar-alt"></i> Published From
                                    </label>
                                    <input type="number" class="form-control" id="year_from" name="year_from" 
                                           value="{{ request.args.get('year_from', '') }}" 
                                           min="1800" max="2024" placeholder="e.g., 2000">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="year_to" class="form-label">
                                        <i class="fas fa-calendar-alt"></i> Published To
                                    </label>
                                    <input type="number" class="form-control" id="year_to" name="year_to" 
                                           value="{{ request.args.get('year_to', '') }}" 
                                           min="1800" max="2024" placeholder="e.g., 2024">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="availability" class="form-label">
                                        <i class="fas fa-check-circle"></i> Availability
                                    </label>
                                    <select class="form-select" id="availability" name="availability">
                                        <option value="">All Books</option>
                                        <option value="Available" 
                                                {% if request.args.get('availability') == 'Available' %}selected{% endif %}>
                                            Available Only
                                        </option>
                                        <option value="Loaned" 
                                                {% if request.args.get('availability') == 'Loaned' %}selected{% endif %}>
                                            Currently Loaned
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search"></i> Search Books
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
                                            <i class="fas fa-times"></i> Clear Filters
                                        </button>
                                        <button type="button" class="btn btn-outline-info" onclick="saveSearch()">
                                            <i class="fas fa-save"></i> Save Search
                                        </button>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary" onclick="loadSavedSearches()">
                                            <i class="fas fa-history"></i> Saved Searches
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results -->
    {% if books %}
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Search Results
                        <span class="badge bg-light text-dark ms-2">{{ books|length }} books found</span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Results Controls -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label class="me-2">Sort by:</label>
                                <select class="form-select form-select-sm" style="width: auto;" onchange="sortResults(this.value)">
                                    <option value="title">Title (A-Z)</option>
                                    <option value="author">Author (A-Z)</option>
                                    <option value="year">Publication Year</option>
                                    <option value="availability">Availability</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleView('grid')" id="gridViewBtn">
                                    <i class="fas fa-th"></i> Grid
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleView('list')" id="listViewBtn">
                                    <i class="fas fa-list"></i> List
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Results Display -->
                    <div id="searchResults">
                        <!-- List View (Default) -->
                        <div class="table-responsive" id="listView">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ISBN</th>
                                        <th>Title</th>
                                        <th>Author</th>
                                        <th>Genre</th>
                                        <th>Year</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    {% for book in books %}
                                    <tr data-title="{{ book[1] }}" data-author="{{ book[2] }}" data-year="{{ book[4] }}" data-availability="{{ book[5] }}">
                                        <td>{{ book[0] }}</td>
                                        <td>
                                            <strong>{{ book[1] }}</strong>
                                        </td>
                                        <td>{{ book[2] }}</td>
                                        <td>
                                            <span class="badge bg-info">{{ book[3] }}</span>
                                        </td>
                                        <td>{{ book[4] }}</td>
                                        <td>
                                            {% if book[5] == 'Available' %}
                                                <span class="badge bg-success">Available</span>
                                            {% else %}
                                                <span class="badge bg-warning">{{ book[5] }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                {% if book[5] == 'Available' %}
                                                    <button class="btn btn-sm btn-outline-primary" onclick="loanBook('{{ book[0] }}')">
                                                        <i class="fas fa-hand-holding"></i> Loan
                                                    </button>
                                                {% endif %}
                                                <button class="btn btn-sm btn-outline-info" onclick="viewDetails('{{ book[0] }}')">
                                                    <i class="fas fa-eye"></i> Details
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="reserveBook('{{ book[0] }}')">
                                                    <i class="fas fa-bookmark"></i> Reserve
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Grid View (Hidden by default) -->
                        <div class="row" id="gridView" style="display: none;">
                            {% for book in books %}
                            <div class="col-md-4 mb-3" data-title="{{ book[1] }}" data-author="{{ book[2] }}" data-year="{{ book[4] }}" data-availability="{{ book[5] }}">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ book[1] }}</h6>
                                        <p class="card-text">
                                            <small class="text-muted">by {{ book[2] }}</small><br>
                                            <span class="badge bg-info">{{ book[3] }}</span>
                                            <span class="badge bg-secondary">{{ book[4] }}</span>
                                        </p>
                                        <div class="mb-2">
                                            {% if book[5] == 'Available' %}
                                                <span class="badge bg-success">Available</span>
                                            {% else %}
                                                <span class="badge bg-warning">{{ book[5] }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="d-grid gap-1">
                                            {% if book[5] == 'Available' %}
                                                <button class="btn btn-sm btn-primary" onclick="loanBook('{{ book[0] }}')">
                                                    <i class="fas fa-hand-holding"></i> Loan Book
                                                </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-info" onclick="viewDetails('{{ book[0] }}')">
                                                <i class="fas fa-eye"></i> View Details
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% elif request.args %}
    <!-- No Results Found -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No books found</h5>
                    <p class="text-muted">Try adjusting your search criteria or clear the filters to see all books.</p>
                    <button type="button" class="btn btn-outline-primary" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Clear All Filters
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Search Tips -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb"></i> Search Tips
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="mb-0">
                                <li>Use partial words to find more results (e.g., "sci" for science fiction)</li>
                                <li>Leave fields blank to include all values</li>
                                <li>Combine multiple filters for precise results</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="mb-0">
                                <li>Use year ranges to find books from specific time periods</li>
                                <li>Filter by availability to find books you can borrow now</li>
                                <li>Save frequent searches for quick access</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function clearSearch() {
    document.getElementById('title').value = '';
    document.getElementById('author').value = '';
    document.getElementById('genre').value = '';
    document.getElementById('year_from').value = '';
    document.getElementById('year_to').value = '';
    document.getElementById('availability').value = '';
    
    // Submit the form to clear results
    window.location.href = "{{ url_for('advanced_search') }}";
}

function toggleView(viewType) {
    const listView = document.getElementById('listView');
    const gridView = document.getElementById('gridView');
    const listBtn = document.getElementById('listViewBtn');
    const gridBtn = document.getElementById('gridViewBtn');
    
    if (viewType === 'grid') {
        listView.style.display = 'none';
        gridView.style.display = 'block';
        listBtn.classList.remove('btn-secondary');
        listBtn.classList.add('btn-outline-secondary');
        gridBtn.classList.remove('btn-outline-secondary');
        gridBtn.classList.add('btn-secondary');
    } else {
        listView.style.display = 'block';
        gridView.style.display = 'none';
        gridBtn.classList.remove('btn-secondary');
        gridBtn.classList.add('btn-outline-secondary');
        listBtn.classList.remove('btn-outline-secondary');
        listBtn.classList.add('btn-secondary');
    }
}

function sortResults(sortBy) {
    // This would implement sorting functionality
    alert(`Sorting by ${sortBy} - functionality would be implemented here`);
}

function loanBook(isbn) {
    if (confirm('Do you want to loan this book?')) {
        // Redirect to loan page or open loan modal
        alert(`Loan functionality for ISBN ${isbn} would be implemented here`);
    }
}

function viewDetails(isbn) {
    alert(`Book details for ISBN ${isbn} would be displayed here`);
}

function reserveBook(isbn) {
    if (confirm('Do you want to reserve this book?')) {
        alert(`Reserve functionality for ISBN ${isbn} would be implemented here`);
    }
}

function saveSearch() {
    const searchParams = new URLSearchParams(window.location.search);
    const searchName = prompt('Enter a name for this search:');
    
    if (searchName) {
        // Save to localStorage or send to server
        const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
        savedSearches.push({
            name: searchName,
            params: searchParams.toString(),
            date: new Date().toLocaleDateString()
        });
        localStorage.setItem('savedSearches', JSON.stringify(savedSearches));
        alert('Search saved successfully!');
    }
}

function loadSavedSearches() {
    const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
    
    if (savedSearches.length === 0) {
        alert('No saved searches found.');
        return;
    }
    
    let searchList = 'Saved Searches:\\n\\n';
    savedSearches.forEach((search, index) => {
        searchList += `${index + 1}. ${search.name} (${search.date})\\n`;
    });
    
    const choice = prompt(searchList + '\\nEnter the number of the search to load (or cancel):');
    
    if (choice && !isNaN(choice) && choice > 0 && choice <= savedSearches.length) {
        const selectedSearch = savedSearches[choice - 1];
        window.location.href = `{{ url_for('advanced_search') }}?${selectedSearch.params}`;
    }
}
</script>
{% endblock %}
